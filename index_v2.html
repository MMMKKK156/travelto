<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>æ—…éŠå°å¹«æ‰‹</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow-x: hidden; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans TC", sans-serif; background: #f0f4f8; }
        .app { max-width: 500px; margin: 0 auto; background: #f7f9fb; min-height: 100vh; box-shadow: 0 0 40px rgba(0,0,0,0.06); }
        
        /* æ–°é…è‰² Header - çŸ¢è»ŠèŠè— & æ·ºæ°´è— */
        .header {
            background: linear-gradient(135deg, #97BEDF 0%, #6A8CC3 50%, #5a7ab0 100%);
            color: #fff;
            padding: 28px 20px;
            position: relative;
            overflow: hidden;
            background-size: 200% 200%;
            animation: gradientShift 15s ease infinite;
        }
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .header::before {
            content: '';
            position: absolute;
            top: -30%;
            right: -15%;
            width: 250px;
            height: 250px;
            background: radial-gradient(circle, rgba(255,255,255,0.18), transparent);
            border-radius: 50%;
            z-index: 0;
            pointer-events: none;
        }
        .header::after {
            content: '';
            position: absolute;
            bottom: -20%;
            left: -10%;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(255,255,255,0.12), transparent);
            border-radius: 50%;
            z-index: 0;
            pointer-events: none;
        }
        .header h1 { 
            font-size: 26px; 
            margin-bottom: 8px; 
            font-weight: 500; 
            letter-spacing: 2px; 
            position: relative; 
            z-index: 1;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .header p { 
            font-size: 13px; 
            opacity: 0.9; 
            letter-spacing: 1px; 
            position: relative; 
            z-index: 1;
            font-weight: 300;
        }
        
        .tabs { display: flex; background: #f7f9fb; border-bottom: 1px solid #dce5ed; position: sticky; top: 0; z-index: 10; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
        .tab { flex: 1; padding: 16px 8px; border: none; background: none; font-size: 13px; cursor: pointer; color: #9a9c8e; transition: all 0.2s; font-weight: 500; }
        .tab.active { color: #4a6070; border-bottom: 2px solid #6A8CC3; }
        
        .content { padding: 18px 18px 120px 18px; min-height: calc(100vh - 200px); }
        .flight-info {
            background: linear-gradient(135deg, #97BEDF 0%, #6A8CC3 100%);
            color: white;
            border-radius: 16px;
            padding: 18px;
            margin-bottom: 16px;
            box-shadow: 0 4px 16px rgba(106,140,195,0.3);
            position: relative;
        }
        .flight-actions {
            position: absolute;
            bottom: 12px;
            right: 12px;
            display: flex;
            gap: 8px;
        }
        .flight-btn {
            width: 28px;
            height: 28px;
            border: 1.5px solid rgba(255,255,255,0.6);
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .flight-btn:active {
            background: rgba(255,255,255,0.2);
        }
        .flight-btn svg {
            width: 14px;
            height: 14px;
            stroke: white;
        }
        .day-slider { display: flex; overflow-x: auto; gap: 10px; margin-bottom: 20px; padding-bottom: 12px; -webkit-overflow-scrolling: touch; }
        .day-slider::-webkit-scrollbar { display: none; }
        .day-btn { min-width: 68px; height: 85px; border-radius: 16px; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 1.5px solid #dce5ed; background: linear-gradient(145deg, #ffffff, #f7f9fb); cursor: pointer; flex-shrink: 0; transition: all 0.25s; box-shadow: 0 2px 6px rgba(0,0,0,0.04); }
        .day-btn.active { background: linear-gradient(135deg, #97BEDF 0%, #6A8CC3 100%); color: white; border-color: #6A8CC3; box-shadow: 0 4px 12px rgba(106,140,195,0.3); }
        .day-btn:active { transform: scale(0.95); }
        
        .card {
            background: linear-gradient(145deg, #ffffff, #f7f9fb);
            border-radius: 16px;
            padding: 18px;
            margin-bottom: 14px;
            border: 1px solid #dce5ed;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04), 0 1px 2px rgba(0,0,0,0.02);
            position: relative;
        }
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.8), transparent);
            border-radius: 16px 16px 0 0;
        }
        .item-card {
            background: linear-gradient(145deg, #ffffff 0%, #f7f9fb 100%);
            border-radius: 16px;
            padding: 18px;
            margin-bottom: 14px;
            border: 1px solid #dce5ed;
            position: relative;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04), 0 1px 3px rgba(0,0,0,0.02);
            overflow: hidden;
        }
        .item-card::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.4) 0%, transparent 70%);
            pointer-events: none;
        }
        .item-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 5px; border-radius: 16px 0 0 16px; }
        .item-card.æ™¯é»::before { background: linear-gradient(180deg, #97BEDF 0%, #7aabcf 50%, #6A8CC3 100%); }
        .item-card.ç¾é£Ÿ::before { background: linear-gradient(180deg, #EACAD5 0%, #e0b5c3 50%, #d6a0b1 100%); }
        .item-card.è³¼ç‰©::before { background: linear-gradient(180deg, #E7C345 0%, #daaf30 50%, #cd9b1b 100%); }
        .item-card.äº¤é€š::before { background: linear-gradient(180deg, #7a9668 0%, #658050 50%, #526636 100%); }
        
        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 14px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
        }
        .btn-primary {
            background: linear-gradient(135deg, #97BEDF 0%, #6A8CC3 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(106,140,195,0.3);
        }
        .btn-secondary {
            background: linear-gradient(135deg, #97BEDF 0%, #7aabcf 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(151,190,223,0.3);
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn-primary:active, .btn-secondary:active { transform: scale(0.98); opacity: 0.9; }
        
        .btn-add-small {
            background: linear-gradient(135deg, #97BEDF, #6A8CC3);
            color: white;
            border: none;
            padding: 13px 16px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            font-weight: 500;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(106,140,195,0.25);
        }
        .btn-add-small:active {
            transform: scale(0.95);
            opacity: 0.9;
        }
        
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: flex-end; justify-content: center; z-index: 1000; backdrop-filter: blur(4px); }
        .modal-content { background: #f7f9fb; border-radius: 20px 20px 0 0; padding: 26px; width: 100%; max-width: 500px; max-height: 85vh; overflow-y: auto; box-shadow: 0 -10px 40px rgba(0,0,0,0.2); -webkit-overflow-scrolling: touch; }
        
        .input { width: 100%; padding: 13px; border: 1.5px solid #dce5ed; border-radius: 12px; margin-top: 6px; font-size: 15px; transition: all 0.2s; background: #fff; }
        .input:focus { outline: none; border-color: #6A8CC3; background: white; box-shadow: 0 0 0 3px rgba(106,140,195,0.1); }
        
        .flex { display: flex; gap: 10px; }
        .flex-1 { flex: 1; }
        .mb-15 { margin-bottom: 15px; }
        .mb-20 { margin-bottom: 20px; }
        .text-center { text-align: center; }
        .text-gray { color: #9a9c8e; }
        .font-bold { font-weight: 600; }
        .label { font-size: 13px; font-weight: 600; color: #4a6070; margin-bottom: 6px; display: block; }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .section-title {
            font-size: 15px;
            font-weight: 600;
            color: #4a6070;
        }
        
        .category-selector { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .category-btn { padding: 11px; border: 1.5px solid #e3e5dd; background: white; border-radius: 12px; cursor: pointer; text-align: center; font-size: 13px; font-weight: 500; }
        .category-btn.æ™¯é» { border-color: #6A8CC3; background: linear-gradient(135deg, #dceaf5, #c8dded); color: #4a6070; box-shadow: 0 2px 6px rgba(106,140,195,0.2); }
        .category-btn.ç¾é£Ÿ { border-color: #EACAD5; background: linear-gradient(135deg, #f7e8ee, #eedce5); color: #7d5855; box-shadow: 0 2px 6px rgba(234,202,213,0.2); }
        .category-btn.è³¼ç‰© { border-color: #E7C345; background: linear-gradient(135deg, #fef5db, #f5ecc8); color: #7a6545; box-shadow: 0 2px 6px rgba(231,195,69,0.2); }
        .category-btn.äº¤é€š { border-color: #526636; background: linear-gradient(135deg, #e8ede5, #dce3d8); color: #3a4a28; box-shadow: 0 2px 6px rgba(82,102,54,0.2); }
        
        .icon-btn { width: 34px; height: 34px; border: none; background: #edf2f7; color: #9a9c8e; border-radius: 10px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
        .icon-btn:active { transform: scale(0.92); }
        .icon-btn.edit { background: linear-gradient(135deg, #dce7ed, #cdd9e0); color: #4a6070; }
        .icon-btn.delete { background: linear-gradient(135deg, #f0e2e0, #e5d5d3); color: #7d5855; }
        .icon-btn svg { width: 17px; height: 17px; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .stat-card {
            background: linear-gradient(145deg, #ffffff, #f7f9fb, #f0f4f8);
            border-radius: 14px;
            padding: 18px;
            text-align: center;
            border: 1px solid #dce5ed;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05), inset 0 1px 0 rgba(255,255,255,0.8);
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(122,157,184,0.08) 0%, transparent 70%);
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.08), inset 0 1px 0 rgba(255,255,255,0.8);
        }
        
        .member-list { display: flex; flex-direction: column; gap: 10px; }
        .member-item { background: linear-gradient(135deg, #f7f9fb, #f0f4f8); border: 1.5px solid #dce5ed; border-radius: 14px; padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; font-size: 15px; font-weight: 500; }
        .member-item .name { flex: 1; color: #5a635a; }
        .member-item .actions { display: flex; gap: 8px; }
        .member-item .edit-input { flex: 1; padding: 8px 12px; border: 1.5px solid #7a9db8; border-radius: 10px; font-size: 15px; }
        
        .map-day-card {
            background: linear-gradient(145deg, #ffffff, #f7f9fb);
            border-radius: 16px;
            padding: 18px;
            margin-bottom: 16px;
            border: 1px solid #dce5ed;
            box-shadow: 0 3px 12px rgba(0,0,0,0.05), 0 1px 3px rgba(0,0,0,0.02);
            position: relative;
            overflow: hidden;
        }
        .map-day-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #97BEDF, #6A8CC3, #5a7ab0);
            border-radius: 16px 16px 0 0;
        }
        .location-badge { display: inline-flex; align-items: center; gap: 4px; padding: 5px 11px; border-radius: 14px; font-size: 12px; margin-right: 6px; margin-bottom: 6px; font-weight: 600; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
        .location-badge.æ™¯é» { background: linear-gradient(135deg, #dceaf5, #c8dded); color: #4a6070; border: 1px solid rgba(106,140,195,0.3); }
        .location-badge.ç¾é£Ÿ { background: linear-gradient(135deg, #f7e8ee, #eedce5); color: #7d5855; border: 1px solid rgba(234,202,213,0.3); }
        .location-badge.è³¼ç‰© { background: linear-gradient(135deg, #fef5db, #f5ecc8); color: #7a6545; border: 1px solid rgba(231,195,69,0.3); }
        .location-badge.äº¤é€š { background: linear-gradient(135deg, #e8ede5, #dce3d8); color: #3a4a28; border: 1px solid rgba(82,102,54,0.3); }
        
        .expense-card {
            background: linear-gradient(145deg, #ffffff, #f7f9fb);
            border-radius: 16px;
            padding: 18px;
            margin-bottom: 14px;
            border: 1px solid #dce5ed;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04), 0 1px 3px rgba(0,0,0,0.02);
            position: relative;
        }
        
        .settlement-section { margin-top: 24px; }
        .settlement-card { background: #f7f9fb; border-radius: 16px; padding: 18px; margin-bottom: 16px; border: 1px solid #dce5ed; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
        .settlement-title { font-size: 15px; font-weight: 600; color: #4a6070; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 2px solid #dce5ed; }
        .settlement-item { background: linear-gradient(135deg, #f7f9fb, #f0f4f8); border-radius: 12px; padding: 14px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #dce5ed; }
        
        .translate-container { display: flex; flex-direction: column; gap: 16px; }
        .translate-btn {
            background: white;
            border: 2px solid #dce5ed;
            border-radius: 18px;
            padding: 24px;
            cursor: pointer;
            text-decoration: none;
            color: inherit;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 3px 12px rgba(0,0,0,0.05);
        }
        .translate-btn:active { transform: scale(0.98); opacity: 0.9; }
        .translate-btn.camera {
            background: linear-gradient(135deg, #EACAD5 0%, #d6a0b1 100%);
            color: white;
            border: none;
            box-shadow: 0 4px 16px rgba(234,202,213,0.3);
        }
        .translate-btn.ch-ja {
            background: linear-gradient(135deg, #97BEDF 0%, #6A8CC3 100%);
            color: white;
            border: none;
            box-shadow: 0 4px 16px rgba(106,140,195,0.3);
        }
        .translate-btn.ja-ch {
            background: linear-gradient(135deg, #E7C345 0%, #daaf30 100%);
            color: white;
            border: none;
            box-shadow: 0 4px 16px rgba(231,195,69,0.3);
        }
        
        /* Headerç·¨è¼¯æ¨£å¼ */
        .header-editable { cursor: pointer; border: 2px solid transparent; border-radius: 8px; padding: 4px 12px; display: inline-block; }
        .header-input { background: rgba(255,255,255,0.95); color: #4a6070; border: none; border-radius: 8px; padding: 8px 12px; font-size: inherit; font-weight: inherit; width: 100%; text-align: center; }
        .header-input:focus { outline: none; box-shadow: 0 0 0 3px rgba(255,255,255,0.3); }

        /* å¤©æ°£æ¨£å¼ */
        .weather-info {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 12px 16px;
            margin-top: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        .weather-info:hover {
            background: rgba(255,255,255,0.25);
            transform: translateY(-1px);
        }
        .weather-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .weather-icon {
            font-size: 36px;
            font-weight: 300;
            opacity: 0.95;
            text-shadow: 0 2px 8px rgba(255,255,255,0.3);
            letter-spacing: -2px;
        }
        .weather-temp {
            font-size: 28px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .weather-desc {
            font-size: 13px;
            opacity: 0.95;
            margin-top: 2px;
            font-weight: 500;
        }
        .weather-loading {
            font-size: 12px;
            opacity: 0.8;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div id="app" class="app">
        <div class="header">
            <div v-if="!editingHeader">
                <div style="cursor: pointer;" v-on:click="startEditHeader">
                    <h1 class="header-editable">{{ tripTitle.toUpperCase() }}</h1>
                    <p class="header-editable" style="font-size: 13px;">{{ tripDates }}</p>
                </div>
                <!-- å¤©æ°£è³‡è¨Š -->
                <div v-if="weather.loaded" class="weather-info">
                    <div class="weather-left">
                        <div class="weather-icon" v-html="weather.icon"></div>
                        <div>
                            <div class="weather-temp">{{ weather.temp }}Â°C</div>
                            <div class="weather-desc">{{ weather.description }}</div>
                        </div>
                    </div>
                    <div style="text-align: right; font-size: 11px; opacity: 0.85;">
                        <div>æ¿•åº¦ {{ weather.humidity }}%</div>
                        <div>é¢¨é€Ÿ {{ weather.windSpeed }} m/s</div>
                    </div>
                </div>
                <div v-else-if="weather.loading" class="weather-info">
                    <div class="weather-loading">â³ è¼‰å…¥å¤©æ°£è³‡è¨Šä¸­...</div>
                </div>
            </div>
            <div v-if="editingHeader" style="padding: 0 5px; position: relative; z-index: 10;">
                <select v-model="tripTitle" style="font-size: 18px; font-weight: 500; letter-spacing: 1px; margin-bottom: 12px; text-align: center; text-align-last: center; cursor: pointer; width: 100%; padding: 16px; padding-right: 40px; border-radius: 8px; border: none; background: rgba(255,255,255,0.95); color: #4a6070; -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url('data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20fill%3D%22%234a6070%22%20d%3D%22M4%206l4%204%204-4z%22%2F%3E%3C%2Fsvg%3E'); background-repeat: no-repeat; background-position: center right 12px; touch-action: manipulation; -webkit-tap-highlight-color: transparent; pointer-events: auto; position: relative; z-index: 10;">
                    <option value="">é¸æ“‡æ—…éŠåŸå¸‚</option>
                    <option value="æ±äº¬">ğŸ‡¯ğŸ‡µ æ±äº¬ (æ—¥åœ“ JPY)</option>
                    <option value="å¤§é˜ª">ğŸ‡¯ğŸ‡µ å¤§é˜ª (æ—¥åœ“ JPY)</option>
                    <option value="äº¬éƒ½">ğŸ‡¯ğŸ‡µ äº¬éƒ½ (æ—¥åœ“ JPY)</option>
                    <option value="ç¦å²¡">ğŸ‡¯ğŸ‡µ ç¦å²¡ (æ—¥åœ“ JPY)</option>
                    <option value="åå¤å±‹">ğŸ‡¯ğŸ‡µ åå¤å±‹ (æ—¥åœ“ JPY)</option>
                    <option value="åŒ—æµ·é“">ğŸ‡¯ğŸ‡µ åŒ—æµ·é“ (æ—¥åœ“ JPY)</option>
                    <option value="æ²–ç¹©">ğŸ‡¯ğŸ‡µ æ²–ç¹© (æ—¥åœ“ JPY)</option>
                    <option value="é¦–çˆ¾">ğŸ‡°ğŸ‡· é¦–çˆ¾ (éŸ“å…ƒ KRW)</option>
                    <option value="é‡œå±±">ğŸ‡°ğŸ‡· é‡œå±± (éŸ“å…ƒ KRW)</option>
                    <option value="æ¿Ÿå·å³¶">ğŸ‡°ğŸ‡· æ¿Ÿå·å³¶ (éŸ“å…ƒ KRW)</option>
                    <option value="æ›¼è°·">ğŸ‡¹ğŸ‡­ æ›¼è°· (æ³°éŠ– THB)</option>
                    <option value="æ¸…é‚">ğŸ‡¹ğŸ‡­ æ¸…é‚ (æ³°éŠ– THB)</option>
                    <option value="æ™®å‰å³¶">ğŸ‡¹ğŸ‡­ æ™®å‰å³¶ (æ³°éŠ– THB)</option>
                    <option value="æ–°åŠ å¡">ğŸ‡¸ğŸ‡¬ æ–°åŠ å¡ (æ–°å¹£ SGD)</option>
                    <option value="å³‡é‡Œå³¶">ğŸ‡®ğŸ‡© å³‡é‡Œå³¶ (ç¾å…ƒ USD)</option>
                    <option value="é›ªæ¢¨">ğŸ‡¦ğŸ‡º é›ªæ¢¨ (æ¾³å¹£ AUD)</option>
                    <option value="å¢¨çˆ¾æœ¬">ğŸ‡¦ğŸ‡º å¢¨çˆ¾æœ¬ (æ¾³å¹£ AUD)</option>
                    <option value="é»ƒé‡‘æµ·å²¸">ğŸ‡¦ğŸ‡º é»ƒé‡‘æµ·å²¸ (æ¾³å¹£ AUD)</option>
                    <option value="ç´ç´„">ğŸ‡ºğŸ‡¸ ç´ç´„ (ç¾å…ƒ USD)</option>
                    <option value="æ´›æ‰ç£¯">ğŸ‡ºğŸ‡¸ æ´›æ‰ç£¯ (ç¾å…ƒ USD)</option>
                    <option value="èˆŠé‡‘å±±">ğŸ‡ºğŸ‡¸ èˆŠé‡‘å±± (ç¾å…ƒ USD)</option>
                    <option value="å€«æ•¦">ğŸ‡¬ğŸ‡§ å€«æ•¦ (æ­å…ƒ EUR)</option>
                    <option value="å·´é»">ğŸ‡«ğŸ‡· å·´é» (æ­å…ƒ EUR)</option>
                    <option value="ç¾…é¦¬">ğŸ‡®ğŸ‡¹ ç¾…é¦¬ (æ­å…ƒ EUR)</option>
                    <option value="å·´å¡éš†ç´">ğŸ‡ªğŸ‡¸ å·´å¡éš†ç´ (æ­å…ƒ EUR)</option>
                    <option value="ä¸Šæµ·">ğŸ‡¨ğŸ‡³ ä¸Šæµ· (äººæ°‘å¹£ CNY)</option>
                    <option value="åŒ—äº¬">ğŸ‡¨ğŸ‡³ åŒ—äº¬ (äººæ°‘å¹£ CNY)</option>
                    <option value="é¦™æ¸¯">ğŸ‡­ğŸ‡° é¦™æ¸¯ (æ¸¯å¹£ HKD)</option>
                    <option value="æ¾³é–€">ğŸ‡²ğŸ‡´ æ¾³é–€ (æ¸¯å¹£ HKD)</option>
                </select>
                <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 12px;">
                    <div>
                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 8px; color: white; text-align: left; font-weight: 500;">é–‹å§‹æ—¥æœŸ</div>
                        <button v-on:click.stop="showDatePicker='start'" style="background: white; color: #333; border: none; border-radius: 10px; padding: 18px; font-size: 16px; width: 100%; cursor: pointer; text-align: center; box-sizing: border-box; font-weight: 600; min-height: 60px; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                            <svg v-if="!startDate" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="opacity: 0.5;"><path d="M9 18l6-6-6-6"/></svg>
                            <span>{{ startDate || 'é»æ­¤é¸æ“‡é–‹å§‹æ—¥æœŸ' }}</span>
                        </button>
                    </div>
                    <div>
                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 8px; color: white; text-align: left; font-weight: 500;">çµæŸæ—¥æœŸ</div>
                        <button v-on:click.stop="showDatePicker='end'" style="background: white; color: #333; border: none; border-radius: 10px; padding: 18px; font-size: 16px; width: 100%; cursor: pointer; text-align: center; box-sizing: border-box; font-weight: 600; min-height: 60px; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                            <svg v-if="!endDate" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="opacity: 0.5;"><path d="M9 18l6-6-6-6"/></svg>
                            <span>{{ endDate || 'é»æ­¤é¸æ“‡çµæŸæ—¥æœŸ' }}</span>
                        </button>
                    </div>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button v-on:click="cancelHeaderEdit" type="button" style="flex: 1; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 14px; border-radius: 8px; font-size: 14px; cursor: pointer; font-weight: 500; touch-action: manipulation; -webkit-tap-highlight-color: transparent; pointer-events: auto; position: relative; z-index: 20;">å–æ¶ˆ</button>
                    <button v-on:click="saveHeaderEdit" type="button" style="flex: 1; background: rgba(255,255,255,0.95); border: none; color: #4a6070; padding: 14px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; touch-action: manipulation; -webkit-tap-highlight-color: transparent; pointer-events: auto; position: relative; z-index: 20;">ç¢ºå®š</button>
                </div>
            </div>
        </div>

        <!-- æ—¥æœŸé¸æ“‡å™¨å½ˆå‡ºè¦–çª— -->
        <div v-if="showDatePicker" v-on:click.stop="showDatePicker=''" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px;">
            <div v-on:click.stop style="background: white; border-radius: 12px; padding: 20px; max-width: 400px; width: 100%;">
                <h3 style="margin: 0 0 15px 0; color: #4a6070; font-size: 18px;">{{ showDatePicker==='start'?'é¸æ“‡é–‹å§‹æ—¥æœŸ':'é¸æ“‡çµæŸæ—¥æœŸ' }}</h3>
                <input v-if="showDatePicker==='start'" v-model="startDate" type="date" style="width: 100%; padding: 12px; font-size: 16px; border: 2px solid #dce5ed; border-radius: 8px; box-sizing: border-box;">
                <input v-if="showDatePicker==='end'" v-model="endDate" type="date" style="width: 100%; padding: 12px; font-size: 16px; border: 2px solid #dce5ed; border-radius: 8px; box-sizing: border-box;">
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button v-on:click.stop="showDatePicker=''" style="flex: 1; background: #dce5ed; color: #4a6070; border: none; padding: 12px; border-radius: 8px; font-size: 14px; cursor: pointer; font-weight: 600;">å–æ¶ˆ</button>
                    <button v-on:click.stop="showDatePicker=''" style="flex: 1; background: #7a9db8; color: white; border: none; padding: 12px; border-radius: 8px; font-size: 14px; cursor: pointer; font-weight: 600;">ç¢ºå®š</button>
                </div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab" v-bind:class="{active: tab==='plan'}" v-on:click="tab='plan'">è¡Œç¨‹</button>
            <button class="tab" v-bind:class="{active: tab==='map'}" v-on:click="tab='map'">åœ°åœ–</button>
            <button class="tab" v-bind:class="{active: tab==='money'}" v-on:click="tab='money'">åˆ†å¸³</button>
            <button class="tab" v-bind:class="{active: tab==='translate'}" v-on:click="tab='translate'">ç¿»è­¯</button>
        </div>

        <div v-if="!dataLoaded" style="padding: 60px 20px; text-align: center; color: #9a9c8e;">
            <div style="font-size: 40px; margin-bottom: 16px;">â³</div>
            <div>è¼‰å…¥ä¸­...</div>
        </div>

        <!-- åˆå§‹ç‹€æ…‹æŒ‡å¼• -->
        <div v-if="dataLoaded && days.length === 0" class="content">
            <div style="padding: 40px 20px; text-align: center;">
                <div style="font-size: 60px; margin-bottom: 20px; opacity: 0.3;">âœˆï¸</div>
                <h2 style="font-size: 22px; color: #4a6070; margin-bottom: 12px; font-weight: 600;">é–‹å§‹æ‚¨çš„æ—…ç¨‹è¦åŠƒ</h2>
                <p style="font-size: 15px; color: #9a9c8e; line-height: 1.8; margin-bottom: 30px;">
                    é»æ“Šä¸Šæ–¹çš„æ¨™é¡Œä¾†é¸æ“‡<br>
                    <strong style="color: #6A8CC3;">æ—…éŠåŸå¸‚</strong> å’Œ <strong style="color: #6A8CC3;">æ—¥æœŸç¯„åœ</strong><br>
                    å³å¯é–‹å§‹è¦åŠƒæ‚¨çš„è¡Œç¨‹
                </p>
                <div style="background: linear-gradient(135deg, rgba(151,190,223,0.1), rgba(106,140,195,0.15)); border: 2px dashed #97BEDF; border-radius: 16px; padding: 24px; margin: 0 auto; max-width: 350px;">
                    <div style="margin-bottom: 12px; display: flex; justify-content: center;">
                        <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="#6A8CC3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="opacity: 0.7;">
                            <path d="M9 18l6-6-6-6"/>
                        </svg>
                    </div>
                    <div style="font-size: 14px; color: #6A8CC3; font-weight: 600; line-height: 1.6;">
                        è«‹é»æ“Šé é¢ä¸Šæ–¹çš„<br>ã€Œæ—…éŠåœ°é»ã€é€²è¡Œè¨­å®š
                    </div>
                </div>
            </div>
        </div>

        <div class="content" v-if="dataLoaded && days.length > 0 && di < days.length">
            <!-- è¡Œç¨‹ -->
            <div v-if="tab==='plan'">
                <div class="day-slider">
                    <div v-for="(d,i) in days" v-bind:key="i" class="day-btn" v-bind:class="{active: di===i}" v-on:click="di=i">
                        <div style="font-size: 10px; opacity: 0.7; font-weight: 600;">{{ d.s }}</div>
                        <div style="font-size: 17px; font-weight: 700; margin-top: 2px;">D{{ i+1 }}</div>
                        <div style="font-size: 10px; opacity: 0.6; font-weight: 500; margin-top: 2px;">{{ d.weekday }}</div>
                    </div>
                </div>

                <!-- èˆªç­è³‡è¨Šç§»åˆ°ä¸Šé¢ -->
                <div v-if="days[di].flight" class="flight-info">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M17.8 19.2 16 11l3.5-3.5C21 6 21.5 4 21 3c-1-.5-3 0-4.5 1.5L13 8 4.8 6.2c-.5-.1-.9.1-1.1.5l-.3.5c-.2.5-.1 1 .3 1.3L9 12l-2 3H4l-1 1 3 2 2 3 1-1v-3l3-2 3.5 5.3c.3.4.8.5 1.3.3l.5-.2c.4-.3.6-.7.5-1.2z"></path>
                        </svg>
                        <span style="font-size: 14px; font-weight: 600;">{{ days[di].flight.airline }} {{ days[di].flight.flightNo }}</span>
                    </div>
                    <div style="font-size: 13px; opacity: 0.9; line-height: 1.6; padding-bottom: 36px;">
                        <div>{{ days[di].flight.departure }}{{ days[di].flight.departureTerminal?' ('+days[di].flight.departureTerminal+')':'' }} â†’ {{ days[di].flight.arrival }}{{ days[di].flight.arrivalTerminal?' ('+days[di].flight.arrivalTerminal+')':'' }}</div>
                        <div>èµ·é£› {{ days[di].flight.departureTime }} / æŠµé” {{ days[di].flight.arrivalTime }}</div>
                    </div>
                    <div class="flight-actions">
                        <button class="flight-btn" v-on:click="editFlight">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                        </button>
                        <button class="flight-btn" v-on:click="deleteFlight">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                        </button>
                    </div>
                </div>

                <!-- ç•¶æ—¥ç¸½è¦½ -->
                <div class="card" style="background: linear-gradient(135deg, #f0f4f8, #e8eef5); border: none; box-shadow: 0 2px 12px rgba(0,0,0,0.04);">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <input v-model="days[di].t" v-on:input="saveData" class="input" style="font-size: 17px; font-weight: 600; background: transparent; border: none; border-bottom: 2px solid #b8cad8; border-radius: 0; padding: 10px 0; cursor: text; flex: 1;" placeholder="ç•¶æ—¥ä¸»é¡Œ">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#b0b0b0" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="opacity: 0.5; flex-shrink: 0; margin-bottom: 8px;">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 14px;">
                        <div style="font-size: 14px; color: #7a9db8; font-weight: 600;">{{ days[di].d }} {{ days[di].weekday }}</div>
                    </div>
                </div>

                <div v-if="days[di].items.length===0" class="text-center text-gray" style="padding: 70px 0;">
                    <div style="font-size: 52px; margin-bottom: 14px; opacity: 0.25;">ğŸ“</div>
                    <div style="font-size: 15px;">å°šç„¡è¡Œç¨‹</div>
                </div>

                <div v-for="(item,i) in days[di].items" v-bind:key="i" class="item-card" v-bind:class="item.category">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                        <div style="flex: 1;">
                            <div style="font-size: 12px; color: #9a9c8e; margin-bottom: 5px; font-weight: 600;">{{ item.time }}</div>
                            <div class="font-bold" style="font-size: 17px; color: #5a635a; margin-bottom: 7px;">{{ item.name }}</div>
                            <div v-if="item.location" style="font-size: 13px; color: #9a9c8e; display: flex; align-items: center; gap: 5px;">
                                <span style="opacity: 0.5;">ğŸ“</span>
                                <span>{{ item.location }}</span>
                            </div>
                        </div>
                        <div class="flex" style="gap: 7px;">
                            <button v-on:click="editItem(i)" class="icon-btn edit">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                            </button>
                            <button v-on:click="delItem(i)" class="icon-btn delete">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                            </button>
                        </div>
                    </div>
                    <div v-if="item.note" style="font-size: 13px; color: #9a9c8e; line-height: 1.7; padding-top: 10px; border-top: 1px solid #e3e5dd; white-space: pre-wrap;">{{ item.note }}</div>
                </div>

                <button class="btn btn-primary" v-on:click="showAdd=true">+ æ–°å¢è¡Œç¨‹</button>
                <button class="btn btn-secondary" v-on:click="showFlightAdd=true">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M17.8 19.2 16 11l3.5-3.5C21 6 21.5 4 21 3c-1-.5-3 0-4.5 1.5L13 8 4.8 6.2c-.5-.1-.9.1-1.1.5l-.3.5c-.2.5-.1 1 .3 1.3L9 12l-2 3H4l-1 1 3 2 2 3 1-1v-3l3-2 3.5 5.3c.3.4.8.5 1.3.3l.5-.2c.4-.3.6-.7.5-1.2z"></path>
                    </svg>
                    æ–°å¢èˆªç­è³‡è¨Š
                </button>
            </div>

            <!-- åœ°åœ–ï¼ˆç§»åˆ°åˆ†å¸³å‰é¢ï¼‰ -->
            <div v-if="tab==='map'">
                <div v-if="days.filter(d=>d.items&&d.items.filter(item=>item.location).length>0).length===0" class="text-center text-gray" style="padding: 90px 0;">
                    <div style="font-size: 60px; margin-bottom: 18px; opacity: 0.25;">ğŸ—ºï¸</div>
                    <div style="font-size: 15px;">è«‹å…ˆåœ¨è¡Œç¨‹ä¸­æ–°å¢åœ°é»</div>
                </div>

                <div v-for="(d,i) in days" v-bind:key="i">
                    <div v-if="d.items&&d.items.filter(item=>item.location).length>0" class="map-day-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 18px;">
                            <div>
                                <div style="font-size: 12px; color: #9a9c8e; font-weight: 600;">{{ d.s }}</div>
                                <div class="font-bold" style="font-size: 17px; color: #5a635a; margin-top: 2px;">Day {{ i+1 }} Â· {{ d.t }}</div>
                            </div>
                            <div style="font-size: 12px; color: #9a9c8e; font-weight: 600;">{{ d.items.filter(item=>item.location).length }} å€‹åœ°é»</div>
                        </div>

                        <div style="margin-top: 14px;">
                            <div v-for="(item,j) in d.items.filter(item=>item.location)" v-bind:key="j" style="margin-bottom: 14px; padding-bottom: 14px; border-bottom: 1px solid #e3e5dd;">
                                <div style="display: flex; align-items: center; gap: 9px; margin-bottom: 5px;">
                                    <span class="location-badge" v-bind:class="item.category">{{ item.category }}</span>
                                    <span style="font-size: 14px; font-weight: 600; color: #5a635a;">{{ item.name }}</span>
                                </div>
                                <a v-bind:href="'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(item.location)" target="_blank" rel="noopener noreferrer" style="font-size: 13px; color: #9a9c8e; padding-left: 9px; cursor: pointer; display: flex; align-items: center; gap: 5px; font-weight: 500; text-decoration: none;">
                                    <span style="opacity: 0.5;">ğŸ“</span>
                                    <span style="text-decoration: underline;">{{ item.location }}</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- åˆ†å¸³ -->
            <div v-if="tab==='money'">
                <div class="card" style="background: linear-gradient(145deg, #e8eaed 0%, #d4d7db 100%); color: #4a4a4a; border: 1px solid #c5c8cc; box-shadow: 0 3px 12px rgba(0,0,0,0.08);">
                    <div style="font-size: 14px; margin-bottom: 14px; opacity: 0.85; font-weight: 600; color: #5a5a5a;">åŒ¯ç‡è¨­å®šèˆ‡æ›ç®—</div>
                    <div class="flex mb-15">
                        <div class="flex-1">
                            <div style="font-size: 12px; opacity: 0.75; margin-bottom: 4px; color: #6a6a6a;">ç›®æ¨™å¹£åˆ¥</div>
                            <select v-model="targetCurrency" v-on:change="saveData" class="input" style="background: rgba(255,255,255,0.7); border: 1px solid #b5b8bc; color: #4a4a4a;">
                                <option value="JPY" style="color: black;">JPY æ—¥åœ“</option>
                                <option value="USD" style="color: black;">USD ç¾å…ƒ</option>
                                <option value="EUR" style="color: black;">EUR æ­å…ƒ</option>
                                <option value="KRW" style="color: black;">KRW éŸ“å…ƒ</option>
                                <option value="THB" style="color: black;">THB æ³°éŠ–</option>
                                <option value="SGD" style="color: black;">SGD æ–°å¹£</option>
                                <option value="CNY" style="color: black;">CNY äººæ°‘å¹£</option>
                                <option value="HKD" style="color: black;">HKD æ¸¯å¹£</option>
                                <option value="AUD" style="color: black;">AUD æ¾³å¹£</option>
                            </select>
                        </div>
                        <div class="flex-1">
                            <div style="font-size: 12px; opacity: 0.75; margin-bottom: 4px; color: #6a6a6a;">åŒ¯ç‡ (1 {{ targetCurrency }} = ? TWD)</div>
                            <input v-model.number="rate" v-on:input="saveData" type="number" step="0.001" class="input" placeholder="0.21" style="background: rgba(255,255,255,0.7); border: 1px solid #b5b8bc; color: #4a4a4a;">
                        </div>
                    </div>
                    <div style="border-top: 1px solid rgba(0,0,0,0.12); padding-top: 12px; margin-top: 4px;">
                        <div style="font-size: 12px; opacity: 0.75; margin-bottom: 8px; color: #6a6a6a;">å¿«é€Ÿæ›ç®—</div>
                        <div class="flex" style="gap: 8px; align-items: stretch;">
                            <input v-model.number="cvAmt" v-on:focus="cvAmt===0?(cvAmt=''):null" type="number" class="input flex-1" placeholder="é‡‘é¡" style="background: rgba(255,255,255,0.7); border: 1px solid #b5b8bc; color: #4a4a4a; margin-top: 0;">
                            <button v-on:click="cvAmt=0" v-if="cvAmt>0" type="button" style="width: 44px; border: 1px solid #b5b8bc; background: rgba(255,255,255,0.5); color: #6a6a6a; border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.2s; padding: 0; touch-action: manipulation; -webkit-tap-highlight-color: transparent;" v-bind:style="{'background': 'rgba(255,255,255,0.5)'}" onmouseover="this.style.background='rgba(255,255,255,0.8)'" onmouseout="this.style.background='rgba(255,255,255,0.5)'">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </button>
                            <select v-model="cvFrom" class="input" style="width: 85px; background: rgba(255,255,255,0.7); border: 1px solid #b5b8bc; color: #4a4a4a; flex-shrink: 0; margin-top: 0;">
                                <option v-bind:value="targetCurrency" style="color: black;">{{ targetCurrency }}</option>
                                <option value="TWD" style="color: black;">TWD</option>
                            </select>
                        </div>
                        <div v-if="cvAmt>0" style="font-size: 22px; font-weight: 600; text-align: center; margin-top: 12px; color: #4a6070;">= {{ cvRes }} {{ cvTo }}</div>
                    </div>
                </div>

                <!-- æ”¯å‡ºè¨˜éŒ„ -->
                <div class="mb-20">
                    <div class="section-header">
                        <div class="section-title">æ”¯å‡ºè¨˜éŒ„</div>
                        <button class="btn-add-small" v-on:click="openExpenseForm">+ æ–°å¢</button>
                    </div>
                    
                    <div v-if="exps.length===0" class="text-center text-gray" style="padding: 70px 0;">
                        <div style="font-size: 52px; margin-bottom: 14px; opacity: 0.25;">ğŸ’³</div>
                        <div style="font-size: 15px;">å°šç„¡æ”¯å‡ºè¨˜éŒ„</div>
                    </div>

                    <div v-for="(e,i) in exps" v-bind:key="i" class="expense-card" v-bind:style="{borderLeft: '4px solid ' + getMemberColor(members.indexOf(e.by))}">
                        <div class="flex" style="justify-content: space-between; margin-bottom: 11px;">
                            <div class="font-bold" style="font-size: 16px; color: #5a635a;">{{ e.desc }}</div>
                            <div style="font-size: 19px; font-weight: 700; color: #4a6070;">{{ e.cur==='TWD'?'NT$':getCurrencySymbol(targetCurrency) }}{{ e.amt }}</div>
                        </div>
                        <div style="font-size: 13px; color: #9a9c8e; margin-bottom: 6px; font-weight: 500;">
                            <span v-if="e.day" style="background: #e8ede5; color: #526636; padding: 2px 8px; border-radius: 6px; font-size: 12px; margin-right: 8px; font-weight: 600;">{{ formatExpenseDay(e.day) }}</span>
                            <span v-bind:style="{color: getMemberColor(members.indexOf(e.by)), fontWeight: 600}">{{ e.by }}</span> æ”¯ä»˜
                        </div>
                        <div style="font-size: 13px; color: #9a9c8e; margin-bottom: 10px; font-weight: 500;">
                            åˆ†çµ¦ï¼š<span v-for="(person,idx) in e.split" v-bind:key="idx">
                                <span v-bind:style="{color: getMemberColor(members.indexOf(person)), fontWeight: 600}">{{ person }}</span><span v-if="idx < e.split.length-1">, </span>
                            </span>
                        </div>
                        <div v-if="e.note" style="font-size: 13px; color: #9a9c8e; line-height: 1.6; padding: 10px; background: rgba(227,229,221,0.3); border-radius: 8px; margin-bottom: 10px; white-space: pre-wrap;">{{ e.note }}</div>
                        <div class="flex" style="justify-content: flex-end; align-items: center;">
                            <div class="flex" style="gap: 7px;">
                                <button v-on:click="editExp(i)" class="icon-btn edit">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                                </button>
                                <button v-on:click="delE(i)" class="icon-btn delete">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ç¸½æ”¯å‡ºçµ±è¨ˆ -->
                <div class="card" style="background: linear-gradient(135deg, #f7f9fb, #f0f4f8); border: none; box-shadow: 0 2px 12px rgba(0,0,0,0.04);">
                    <div class="font-bold mb-15" style="font-size: 15px; color: #4a6070;">ç¸½æ”¯å‡ºçµ±è¨ˆ</div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div style="font-size: 30px; font-weight: 700; color: #4a6070; margin-bottom: 5px;">{{ exps.length }}</div>
                            <div style="font-size: 12px; color: #9a9c8e; font-weight: 600;">ç­†æ•¸</div>
                        </div>
                        <div class="stat-card">
                            <div style="font-size: 30px; font-weight: 700; color: #4a6070; margin-bottom: 5px;">{{ totTWD }}</div>
                            <div style="font-size: 12px; color: #9a9c8e; font-weight: 600;">TWD</div>
                        </div>
                    </div>
                    <div class="text-center" style="margin-top: 14px; font-size: 13px; color: #9a9c8e; font-weight: 500;">{{ getCurrencyName(targetCurrency) }} ç´„ {{ getCurrencySymbol(targetCurrency) }}{{ totTarget }}</div>
                </div>

                <div v-if="settlesTarget.length>0 || settlesTWD.length>0" class="settlement-section">
                    <div v-if="settlesTarget.length>0" class="settlement-card">
                        <div class="settlement-title">{{ getTargetFlag() }} {{ getCurrencyName(targetCurrency) }}çµç®—</div>
                        <div v-for="(s,i) in settlesTarget" v-bind:key="i" class="settlement-item">
                            <div style="display: flex; align-items: center; gap: 10px; font-size: 14px; font-weight: 500; color: #5a635a;">
                                <span>{{ s.from }}</span>
                                <span style="color: #7a9db8; font-weight: 700;">â†’</span>
                                <span>{{ s.to }}</span>
                            </div>
                            <div style="font-size: 17px; font-weight: 700; color: #7a9db8;">{{ getCurrencySymbol(targetCurrency) }}{{ s.amt }}</div>
                        </div>
                    </div>

                    <div v-if="settlesTWD.length>0" class="settlement-card">
                        <div class="settlement-title">ğŸ‡¹ğŸ‡¼ å°å¹£çµç®—</div>
                        <div v-for="(s,i) in settlesTWD" v-bind:key="i" class="settlement-item">
                            <div style="display: flex; align-items: center; gap: 10px; font-size: 14px; font-weight: 500; color: #5a635a;">
                                <span>{{ s.from }}</span>
                                <span style="color: #7a9db8; font-weight: 700;">â†’</span>
                                <span>{{ s.to }}</span>
                            </div>
                            <div style="font-size: 17px; font-weight: 700; color: #7a9db8;">NT$ {{ s.amt }}</div>
                        </div>
                    </div>
                </div>

                <!-- æˆå“¡ç®¡ç†ç§»è‡³æœ€ä¸‹æ–¹ -->
                <div class="mb-20" style="margin-top: 30px;">
                    <div class="font-bold mb-15" style="font-size: 15px; color: #4a6070;">æˆå“¡ç®¡ç†</div>
                    <div class="member-list">
                        <div v-for="(m,i) in members" v-bind:key="i" class="member-item">
                            <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                                <div v-bind:style="{width: '12px', height: '12px', borderRadius: '50%', flexShrink: 0, background: getMemberColor(i)}"></div>
                                <input v-if="editingMember===i" v-model="editMemberName" class="edit-input" v-on:keyup.enter="saveMemberEdit(i)" placeholder="æˆå“¡åç¨±" style="flex: 1;">
                                <span v-else class="name" style="flex: 1;">{{ m }}</span>
                            </div>
                            <div class="actions">
                                <button v-if="editingMember===i" v-on:click="saveMemberEdit(i)" style="background: #6A8CC3; color: white; border: none; padding: 6px 12px; border-radius: 8px; font-size: 13px; cursor: pointer;">å„²å­˜</button>
                                <button v-if="editingMember===i" v-on:click="cancelMemberEdit" style="background: #9a9c8e; color: white; border: none; padding: 6px 12px; border-radius: 8px; font-size: 13px; cursor: pointer;">å–æ¶ˆ</button>
                                <button v-if="editingMember!==i" v-on:click="startEditMember(i,m)" style="background: #97BEDF; color: white; border: none; padding: 6px 12px; border-radius: 8px; font-size: 13px; cursor: pointer;">ç·¨è¼¯</button>
                                <button v-if="editingMember!==i" v-on:click="delM(i)" style="background: #EACAD5; color: white; border: none; padding: 6px 12px; border-radius: 8px; font-size: 13px; cursor: pointer;">åˆªé™¤</button>
                            </div>
                        </div>
                    </div>
                    <div class="flex" style="margin-top: 14px;">
                        <input v-model="newM" v-on:keyup.enter="addM" class="input flex-1" placeholder="æ–°å¢æˆå“¡">
                        <button class="btn btn-primary" style="width: auto; padding: 13px 16px;" v-on:click="addM">æ–°å¢</button>
                    </div>
                </div>

                <!-- æ•¸æ“šç®¡ç† -->
                <div class="mb-20" style="margin-top: 30px;">
                    <div class="font-bold mb-15" style="font-size: 15px; color: #4a6070;">æ•¸æ“šç®¡ç†</div>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button v-on:click="doExport" class="btn" style="background: linear-gradient(135deg, #97BEDF, #6A8CC3); color: white; font-weight: 600; padding: 14px; border: none;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 8px;">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                            åŒ¯å‡ºè¡Œç¨‹è³‡æ–™
                        </button>
                        <button v-on:click="triggerImport" class="btn" style="background: linear-gradient(135deg, #E7C345, #daaf30); color: white; font-weight: 600; padding: 14px; border: none;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 8px;">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="17 8 12 3 7 8"></polyline>
                                <line x1="12" y1="3" x2="12" y2="15"></line>
                            </svg>
                            åŒ¯å…¥è¡Œç¨‹è³‡æ–™
                        </button>
                        <button v-on:click="clearAllData" class="btn" style="background: linear-gradient(135deg, #EACAD5, #d6a0b1); color: white; font-weight: 600; padding: 14px; border: none;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 8px;">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                            æ¸…é™¤æ‰€æœ‰è³‡æ–™
                        </button>
                    </div>
                    <input type="file" id="importFile" accept=".json" style="display: none;" v-on:change="doImport">
                </div>
            </div>

            <!-- ç¿»è­¯ -->
            <div v-if="tab==='translate'">
                <h2 style="font-size: 24px; font-weight: 600; color: #4a6070; text-align: center; margin-bottom: 10px;">Google ç¿»è­¯æ·å¾‘</h2>
                <p style="font-size: 14px; color: #9a9c8e; text-align: center; margin-bottom: 30px;">è«‹é¸æ“‡æ‚¨éœ€è¦çš„ç¿»è­¯æ¨¡å¼</p>

                <div class="translate-container">
                    <a v-bind:href="'https://translate.google.com/?sl=' + getTranslateCode() + '&tl=zh-TW&op=images'" target="_blank" rel="noopener noreferrer" class="translate-btn camera">
                        <div>
                            <div style="font-size: 13px; opacity: 0.9; margin-bottom: 6px;">èœå–® / çœ‹æ¿</div>
                            <div style="font-size: 22px; font-weight: 600;">ç…§ç›¸ç¿»è­¯ ğŸ“·</div>
                        </div>
                        <div style="font-size: 48px; opacity: 0.2;">ğŸ“¸</div>
                    </a>

                    <a v-bind:href="'https://translate.google.com/?sl=zh-TW&tl=' + getTranslateCode() + '&op=translate'" target="_blank" rel="noopener noreferrer" class="translate-btn ch-ja">
                        <div>
                            <div style="font-size: 13px; opacity: 0.9; margin-bottom: 6px;">æˆ‘èªªä¸­æ–‡ï¼ˆè½‰{{ getTargetLangName() }}ï¼‰</div>
                            <div style="font-size: 22px; font-weight: 600;">ä¸­æ–‡ â†’ {{ getTargetLangName() }} â†—</div>
                        </div>
                    </a>

                    <a v-bind:href="'https://translate.google.com/?sl=' + getTranslateCode() + '&tl=zh-TW&op=translate'" target="_blank" rel="noopener noreferrer" class="translate-btn ja-ch">
                        <div>
                            <div style="font-size: 13px; opacity: 0.9; margin-bottom: 6px;">å°æ–¹èªª{{ getTargetLangName() }}ï¼ˆè½‰ä¸­æ–‡ï¼‰</div>
                            <div style="font-size: 22px; font-weight: 600;">{{ getTargetLangName() }} â†’ ä¸­æ–‡ â†—</div>
                        </div>
                    </a>
                </div>
            </div>
        </div>

        <!-- Modals ä¿æŒä¸è®Šä½†æ›´æ–°èˆªç­è¡¨å–®... -->
        <div v-if="showAdd" v-on:click.self="closeAdd" class="modal">
            <div class="modal-content" v-on:click.stop>
                <h3 style="font-size: 21px; font-weight: 600; margin-bottom: 22px; color: #4a6070;">{{ editIdx!==null?'ç·¨è¼¯è¡Œç¨‹':'æ–°å¢è¡Œç¨‹' }}</h3>
                
                <div class="mb-15">
                    <label class="label">æ™‚é–“</label>
                    <div class="flex">
                        <select v-model="form.h" class="input flex-1">
                            <option v-for="h in 24" v-bind:key="h" v-bind:value="pad(h-1)">{{ pad(h-1) }}</option>
                        </select>
                        <span style="font-size: 22px; color: #c8cbbe; display: flex; align-items: center;">:</span>
                        <select v-model="form.m" class="input flex-1">
                            <option value="00">00</option><option value="05">05</option><option value="10">10</option>
                            <option value="15">15</option><option value="20">20</option><option value="25">25</option>
                            <option value="30">30</option><option value="35">35</option><option value="40">40</option>
                            <option value="45">45</option><option value="50">50</option><option value="55">55</option>
                        </select>
                    </div>
                </div>

                <div class="mb-15">
                    <label class="label">è¡Œç¨‹åç¨±</label>
                    <input v-model="form.name" class="input" placeholder="ä¾‹ï¼šå¤§é˜ªåŸå¤©å®ˆé–£">
                </div>

                <div class="mb-15">
                    <label class="label">åœ°é»ï¼ˆé¸å¡«ï¼‰</label>
                    <input v-model="form.location" class="input" placeholder="ä¾‹ï¼šå¤§é˜ªåŸå…¬åœ’ 1-1">
                </div>

                <div class="mb-15">
                    <label class="label">é¡å‹</label>
                    <div class="category-selector">
                        <button v-on:click="form.category='æ™¯é»'" class="category-btn" v-bind:class="{'æ™¯é»': form.category==='æ™¯é»'}">æ™¯é»</button>
                        <button v-on:click="form.category='ç¾é£Ÿ'" class="category-btn" v-bind:class="{'ç¾é£Ÿ': form.category==='ç¾é£Ÿ'}">ç¾é£Ÿ</button>
                        <button v-on:click="form.category='è³¼ç‰©'" class="category-btn" v-bind:class="{'è³¼ç‰©': form.category==='è³¼ç‰©'}">è³¼ç‰©</button>
                        <button v-on:click="form.category='äº¤é€š'" class="category-btn" v-bind:class="{'äº¤é€š': form.category==='äº¤é€š'}">äº¤é€š</button>
                    </div>
                </div>

                <div class="mb-20">
                    <label class="label">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
                    <textarea v-model="form.note" class="input" style="height: 105px; resize: vertical; line-height: 1.6;" placeholder="è¨˜éŒ„é‡è¦è³‡è¨Š&#10;å¯ä»¥æ›è¡Œè¼¸å…¥"></textarea>
                </div>

                <div class="flex">
                    <button class="btn flex-1" style="background: #dce5ed; color: #4a6070; font-weight: 600;" v-on:click="closeAdd">å–æ¶ˆ</button>
                    <button class="btn btn-primary flex-1" v-on:click="saveAdd">å„²å­˜</button>
                </div>
            </div>
        </div>

        <div v-if="showFlightAdd" v-on:click.self="closeFlightAdd" class="modal">
            <div class="modal-content" v-on:click.stop>
                <h3 style="font-size: 21px; font-weight: 600; margin-bottom: 22px; color: #4a6070;">{{ editingFlight?'ç·¨è¼¯èˆªç­è³‡è¨Š':'æ–°å¢èˆªç­è³‡è¨Š' }}</h3>
                
                <div class="mb-15">
                    <label class="label">èˆªç©ºå…¬å¸</label>
                    <input v-model="flightForm.airline" class="input" placeholder="ä¾‹ï¼šé•·æ¦®èˆªç©º">
                </div>

                <div class="mb-15">
                    <label class="label">èˆªç­ç·¨è™Ÿ</label>
                    <input v-model="flightForm.flightNo" class="input" placeholder="ä¾‹ï¼šBR178">
                </div>

                <div class="mb-15">
                    <label class="label">å‡ºç™¼åœ°</label>
                    <input v-model="flightForm.departure" class="input" placeholder="ä¾‹ï¼šæ¡ƒåœ’æ©Ÿå ´ TPE">
                </div>
                
                <div class="mb-15">
                    <label class="label">å‡ºç™¼èˆªå»ˆï¼ˆé¸å¡«ï¼‰</label>
                    <input v-model="flightForm.departureTerminal" class="input" placeholder="ä¾‹ï¼šç¬¬äºŒèˆªå»ˆ">
                </div>

                <div class="mb-15">
                    <label class="label">ç›®çš„åœ°</label>
                    <input v-model="flightForm.arrival" class="input" placeholder="ä¾‹ï¼šé—œè¥¿æ©Ÿå ´ KIX">
                </div>
                
                <div class="mb-15">
                    <label class="label">æŠµé”èˆªå»ˆï¼ˆé¸å¡«ï¼‰</label>
                    <input v-model="flightForm.arrivalTerminal" class="input" placeholder="ä¾‹ï¼šç¬¬ä¸€èˆªå»ˆ">
                </div>

                <div class="mb-15">
                    <label class="label">èµ·é£›æ™‚é–“</label>
                    <input v-model="flightForm.departureTime" class="input" placeholder="ä¾‹ï¼š10:55">
                </div>

                <div class="mb-20">
                    <label class="label">æŠµé”æ™‚é–“</label>
                    <input v-model="flightForm.arrivalTime" class="input" placeholder="ä¾‹ï¼š14:55">
                </div>

                <div class="flex">
                    <button class="btn flex-1" style="background: #dce5ed; color: #4a6070; font-weight: 600;" v-on:click="closeFlightAdd">å–æ¶ˆ</button>
                    <button class="btn btn-primary flex-1" v-on:click="saveFlightAdd">å„²å­˜</button>
                </div>
            </div>
        </div>

        <div v-if="showExpAdd" v-on:click.self="closeExpAdd" class="modal">
            <div class="modal-content" v-on:click.stop>
                <h3 style="font-size: 21px; font-weight: 600; margin-bottom: 22px; color: #4a6070;">{{ editExpIdx!==null?'ç·¨è¼¯æ”¯å‡º':'æ–°å¢æ”¯å‡º' }}</h3>
                
                <div class="mb-15">
                    <label class="label">é …ç›®</label>
                    <input v-model="expForm.desc" class="input" placeholder="ä¾‹ï¼šåˆé¤">
                </div>

                <div class="mb-15">
                    <label class="label">æ”¯å‡ºæ—¥æœŸ</label>
                    <select v-model="expForm.day" class="input">
                        <option value="è¡Œå‰æ”¯å‡º">è¡Œå‰æ”¯å‡º</option>
                        <option v-for="(d, idx) in days" v-bind:key="idx" v-bind:value="'D' + (idx + 1)">D{{ idx + 1 }} - {{ d.d }}</option>
                    </select>
                </div>

                <div class="mb-15">
                    <label class="label">å¹£åˆ¥</label>
                    <div class="flex">
                        <button v-on:click="expForm.cur='TWD'" class="btn flex-1" v-bind:style="{background: expForm.cur==='TWD'?'linear-gradient(135deg, #7a9db8, #6087a0)':'#dce5ed', color: expForm.cur==='TWD'?'white':'#4a6070'}">å°å¹£ TWD</button>
                        <button v-on:click="expForm.cur=targetCurrency" class="btn flex-1" v-bind:style="{background: expForm.cur===targetCurrency?'linear-gradient(135deg, #7a9db8, #6087a0)':'#dce5ed', color: expForm.cur===targetCurrency?'white':'#4a6070'}">{{ getCurrencyName(targetCurrency) }}</button>
                    </div>
                </div>

                <div class="mb-15">
                    <label class="label">é‡‘é¡</label>
                    <input v-model.number="expForm.amt" type="number" class="input" placeholder="è¼¸å…¥é‡‘é¡">
                </div>

                <div class="mb-15">
                    <label class="label">ç”±èª°æ”¯ä»˜</label>
                    <select v-model="expForm.by" class="input">
                        <option value="">è«‹é¸æ“‡</option>
                        <option v-for="m in members" v-bind:key="m" v-bind:value="m">{{ m }}</option>
                    </select>
                </div>

                <div class="mb-15">
                    <label class="label">åˆ†çµ¦èª°</label>
                    <div style="background: #fff; border-radius: 12px; padding: 14px; max-height: 160px; overflow-y: auto; border: 1px solid #e3e5dd;">
                        <label style="display: flex; align-items: center; gap: 11px; padding: 9px; cursor: pointer; border-bottom: 1px solid #e3e5dd; margin-bottom: 8px;">
                            <input type="checkbox" v-bind:checked="expForm.split.length === members.length && members.length > 0" v-on:change="toggleSelectAll" style="width: 19px; height: 19px; cursor: pointer;">
                            <span style="font-size: 14px; font-weight: 600; color: #6A8CC3;">å…¨é¸</span>
                        </label>
                        <label v-for="m in members" v-bind:key="m" style="display: flex; align-items: center; gap: 11px; padding: 9px; cursor: pointer;">
                            <input type="checkbox" v-bind:value="m" v-model="expForm.split" style="width: 19px; height: 19px; cursor: pointer;">
                            <span style="font-size: 14px; font-weight: 500;">{{ m }}</span>
                        </label>
                    </div>
                </div>

                <div class="mb-20">
                    <label class="label">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
                    <textarea v-model="expForm.note" class="input" style="height: 80px; resize: vertical; line-height: 1.6;" placeholder="è¨˜éŒ„ç´°ç¯€è³‡è¨Š"></textarea>
                </div>

                <div class="flex">
                    <button class="btn flex-1" style="background: #dce5ed; color: #4a6070; font-weight: 600;" v-on:click="closeExpAdd">å–æ¶ˆ</button>
                    <button class="btn btn-primary flex-1" v-on:click="saveExpAdd">å„²å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æª¢æŸ¥ Vue æ˜¯å¦æˆåŠŸè¼‰å…¥
        if (typeof Vue === 'undefined') {
            document.body.innerHTML = '<div style="padding: 20px; text-align: center;"><h1>è¼‰å…¥å¤±æ•—</h1><p>Vue.js ç„¡æ³•è¼‰å…¥ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–é‡æ–°æ•´ç†é é¢ã€‚</p></div>';
            throw new Error('Vue is not loaded');
        }

        const memberColors = ['#7a9db8', '#94b3d1', '#8da9c4', '#7b9aaf', '#6087a0', '#7a95b0', '#6a8a9f', '#8297ac'];
        
        const app = Vue.createApp({
            data() {
                return {
                    dataLoaded: false,
                    tab: 'plan',
                    di: 0,
                    showAdd: false,
                    showExpAdd: false,
                    showFlightAdd: false,
                    editIdx: null,
                    editExpIdx: null,
                    editingMember: null,
                    editMemberName: '',
                    editingFlight: false,
                    editingHeader: false,
                    showDatePicker: '',
                    tripTitle: 'æ—…éŠåœ°é»',
                    tripDates: 'æ—¥æœŸç¯„åœ',
                    startDate: '',
                    endDate: '',
                    backupTitle: '',
                    backupDates: '',
                    backupStartDate: '',
                    backupEndDate: '',
                    targetCurrency: 'JPY',
                    form: {h:'09',m:'00',name:'',location:'',category:'æ™¯é»',note:''},
                    expForm: {desc:'',amt:0,cur:'JPY',by:'',split:[],note:'',day:'è¡Œå‰æ”¯å‡º'},
                    flightForm: {airline:'',flightNo:'',departure:'',departureTerminal:'',arrival:'',arrivalTerminal:'',departureTime:'',arrivalTime:''},
                    days: [],
                    members: [],
                    newM: '',
                    exps: [],
                    rate: 0.21,
                    cvAmt: 0,
                    cvFrom: 'JPY',
                    weather: {
                        loading: false,
                        loaded: false,
                        temp: 0,
                        description: '',
                        icon: 'ğŸŒ¤ï¸',
                        humidity: 0,
                        windSpeed: 0
                    }
                };
            },
            computed: {
                totTWD() {
                    var sum = 0;
                    for (var i=0; i<this.exps.length; i++) {
                        sum += this.exps[i].cur==='TWD' ? this.exps[i].amt : this.exps[i].amt*this.rate;
                    }
                    return Math.round(sum);
                },
                totTarget() {
                    var sum = 0;
                    for (var i=0; i<this.exps.length; i++) {
                        sum += this.exps[i].cur===this.targetCurrency ? this.exps[i].amt : this.exps[i].amt/this.rate;
                    }
                    return Math.round(sum);
                },
                cvTo() { return this.cvFrom===this.targetCurrency?'TWD':this.targetCurrency; },
                cvRes() {
                    if (this.cvFrom===this.targetCurrency) {
                        return Math.round(this.cvAmt*this.rate);
                    } else {
                        return Math.round(this.cvAmt/this.rate);
                    }
                },
                settlesTarget() { return this.calcSettles(this.targetCurrency); },
                settlesTWD() { return this.calcSettles('TWD'); }
            },
            methods: {
                pad(n) { return String(n).padStart(2,'0'); },
                getMemberColor(memberName) {
                    var idx = this.members.indexOf(memberName);
                    return memberColors[idx % memberColors.length];
                },
                editFlight() {
                    if (!this.days[this.di] || !this.days[this.di].flight) return;
                    var f = this.days[this.di].flight;
                    this.flightForm = {
                        airline: f.airline,
                        flightNo: f.flightNo,
                        departure: f.departure,
                        departureTerminal: f.departureTerminal || '',
                        arrival: f.arrival,
                        arrivalTerminal: f.arrivalTerminal || '',
                        departureTime: f.departureTime,
                        arrivalTime: f.arrivalTime
                    };
                    this.editingFlight = true;
                    this.showFlightAdd = true;
                },
                deleteFlight() {
                    if (!this.days[this.di]) return;
                    delete this.days[this.di].flight;
                    this.saveData();
                },
                startEditMember(idx, name) {
                    this.editingMember = idx;
                    this.editMemberName = name;
                },
                saveMemberEdit(idx) {
                    if (this.editMemberName.trim()) {
                        this.members[idx] = this.editMemberName.trim();
                        this.editingMember = null;
                        this.editMemberName = '';
                        this.saveData();
                    }
                },
                cancelMemberEdit() {
                    this.editingMember = null;
                    this.editMemberName = '';
                },
                saveData() {
                    try {
                        localStorage.setItem('travel_days', JSON.stringify(this.days));
                        localStorage.setItem('travel_members', JSON.stringify(this.members));
                        localStorage.setItem('travel_exps', JSON.stringify(this.exps));
                        localStorage.setItem('travel_di', String(this.di));
                        localStorage.setItem('travel_tab', this.tab);
                        localStorage.setItem('travel_title', this.tripTitle);
                        localStorage.setItem('travel_dates', this.tripDates);
                        localStorage.setItem('travel_rate', String(this.rate));
                        localStorage.setItem('travel_currency', this.targetCurrency);
                    } catch(e) {
                        console.error('å„²å­˜å¤±æ•—:', e);
                    }
                },
                loadData() {
                    try {
                        var savedDays = localStorage.getItem('travel_days');
                        var savedMembers = localStorage.getItem('travel_members');
                        var savedExps = localStorage.getItem('travel_exps');
                        var savedDi = localStorage.getItem('travel_di');
                        var savedTab = localStorage.getItem('travel_tab');
                        var savedTitle = localStorage.getItem('travel_title');
                        var savedDates = localStorage.getItem('travel_dates');
                        var savedRate = localStorage.getItem('travel_rate');
                        var savedCurrency = localStorage.getItem('travel_currency');
                        
                        if (savedDays) {
                            this.days = JSON.parse(savedDays);
                        } else {
                            this.loadDefaultDays();
                        }
                        
                        if (savedMembers) {
                            this.members = JSON.parse(savedMembers);
                        } else {
                            this.members = ['æˆå“¡ä¸€','æˆå“¡äºŒ'];
                        }
                        
                        if (savedExps) {
                            this.exps = JSON.parse(savedExps);
                        }
                        
                        if (savedDi) {
                            var idx = parseInt(savedDi);
                            if (!isNaN(idx) && idx >= 0 && idx < this.days.length) {
                                this.di = idx;
                            } else {
                                this.di = 0;
                            }
                        }
                        
                        if (savedTab) {
                            this.tab = savedTab;
                        }
                        
                        if (savedTitle) {
                            this.tripTitle = savedTitle;
                        }
                        
                        if (savedDates) {
                            this.tripDates = savedDates;
                        }
                        
                        if (savedRate) {
                            this.rate = parseFloat(savedRate);
                        }
                        
                        if (savedCurrency) {
                            this.targetCurrency = savedCurrency;
                            this.cvFrom = savedCurrency;
                            this.expForm.cur = savedCurrency;
                        }
                        
                        // å¾daysè¨ˆç®—startDateå’ŒendDate
                        if (this.days.length > 0) {
                            var firstDate = this.parseDateString(this.days[0].d);
                            var lastDate = this.parseDateString(this.days[this.days.length-1].d);
                            this.startDate = this.toISODate(firstDate);
                            this.endDate = this.toISODate(lastDate);
                        }
                        
                        this.dataLoaded = true;
                    } catch(e) {
                        console.error('è¼‰å…¥å¤±æ•—:', e);
                        this.loadDefaultDays();
                        this.members = ['æˆå“¡ä¸€','æˆå“¡äºŒ'];
                        this.di = 0;
                        this.dataLoaded = true;
                    }
                },
                loadDefaultDays() {
                    var today = new Date();
                    var tomorrow = new Date(today);
                    tomorrow.setDate(today.getDate() + 1);
                    this.days = [
                        {d:this.formatDate(today),s:this.formatShortDate(today),t:'ç¬¬ä¸€å¤©',items:[],weekday:this.getWeekday(today)},
                        {d:this.formatDate(tomorrow),s:this.formatShortDate(tomorrow),t:'ç¬¬äºŒå¤©',items:[],weekday:this.getWeekday(tomorrow)}
                    ];
                },
                sortItems() {
                    if (this.days[this.di] && this.days[this.di].items) {
                        this.days[this.di].items.sort(function(a,b){ return a.time.localeCompare(b.time); });
                    }
                },
                addDay() {
                    if (this.days.length === 0) return;
                    // å¾æœ€å¾Œä¸€å¤©çš„å®Œæ•´æ—¥æœŸå­—ä¸²å–å¾—æ—¥æœŸ
                    var lastDay = this.days[this.days.length-1];
                    var lastDate = this.parseDateString(lastDay.d);
                    
                    // åŠ ä¸€å¤©
                    var newDate = new Date(lastDate);
                    newDate.setDate(lastDate.getDate() + 1);
                    
                    this.days.push({
                        d: this.formatDate(newDate), 
                        s: this.formatShortDate(newDate), 
                        t: 'è¡Œç¨‹è¦åŠƒ', 
                        items:[],
                        weekday: this.getWeekday(newDate)
                    });
                    this.di = this.days.length-1;
                    this.saveData();
                },
                deleteDay(index) {
                    if (this.days.length <= 1) {
                        alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€å¤©');
                        return;
                    }
                    if (confirm('ç¢ºå®šè¦åˆªé™¤é€™ä¸€å¤©çš„è¡Œç¨‹å—ï¼Ÿ')) {
                        this.days.splice(index, 1);
                        if (this.di >= this.days.length) {
                            this.di = this.days.length - 1;
                        }
                        this.saveData();
                    }
                },
                editItem(i) {
                    if (!this.days[this.di] || !this.days[this.di].items[i]) return;
                    this.editIdx = i;
                    var item = this.days[this.di].items[i];
                    var t = item.time.split(':');
                    this.form = {h:t[0],m:t[1],name:item.name,location:item.location||'',category:item.category,note:item.note||''};
                    this.showAdd = true;
                },
                delItem(i) {
                    if (!this.days[this.di] || !this.days[this.di].items[i]) return;
                    this.days[this.di].items.splice(i,1);
                    this.saveData();
                },
                saveAdd() {
                    if (!this.form.name || !this.days[this.di]) { 
                        alert('è«‹å¡«å¯«è¡Œç¨‹åç¨±'); 
                        return; 
                    }
                    var item = {time: this.form.h+':'+this.form.m, name: this.form.name, location: this.form.location, category: this.form.category, note: this.form.note};
                    if (this.editIdx!==null && this.days[this.di].items[this.editIdx]) {
                        this.days[this.di].items[this.editIdx] = item;
                    } else {
                        this.days[this.di].items.push(item);
                    }
                    this.sortItems();
                    this.closeAdd();
                    this.saveData();
                },
                closeAdd() {
                    this.showAdd=false; 
                    this.editIdx=null;
                    this.form={h:'09',m:'00',name:'',location:'',category:'æ™¯é»',note:''};
                },
                saveFlightAdd() {
                    if (!this.flightForm.airline || !this.flightForm.flightNo) {
                        alert('è«‹å¡«å¯«èˆªç©ºå…¬å¸å’Œèˆªç­ç·¨è™Ÿ');
                        return;
                    }
                    this.days[this.di].flight = {
                        airline: this.flightForm.airline,
                        flightNo: this.flightForm.flightNo,
                        departure: this.flightForm.departure,
                        departureTerminal: this.flightForm.departureTerminal,
                        arrival: this.flightForm.arrival,
                        arrivalTerminal: this.flightForm.arrivalTerminal,
                        departureTime: this.flightForm.departureTime,
                        arrivalTime: this.flightForm.arrivalTime
                    };
                    this.closeFlightAdd();
                    this.saveData();
                },
                closeFlightAdd() {
                    this.showFlightAdd = false;
                    this.editingFlight = false;
                    this.flightForm = {airline:'',flightNo:'',departure:'',departureTerminal:'',arrival:'',arrivalTerminal:'',departureTime:'',arrivalTime:''};
                },
                addM() {
                    if (this.newM.trim() && this.members.indexOf(this.newM.trim())===-1) {
                        this.members.push(this.newM.trim());
                        this.newM='';
                        this.saveData();
                    }
                },
                delM(i) {
                    this.members.splice(i,1);
                    this.saveData();
                },
                editExp(i) {
                    if (!this.exps[i]) return;
                    this.editExpIdx = i;
                    var e = this.exps[i];
                    this.expForm = {desc:e.desc, amt:e.amt, cur:e.cur, by:e.by, split:[...e.split], note:e.note||'', day:e.day||'è¡Œå‰æ”¯å‡º'};
                    this.showExpAdd = true;
                },
                saveExpAdd() {
                    if (!this.expForm.desc || !this.expForm.amt || !this.expForm.by || this.expForm.split.length===0) {
                        alert('è«‹å¡«å¯«å®Œæ•´è³‡è¨Š');
                        return;
                    }
                    var newExp = {desc:this.expForm.desc, amt:this.expForm.amt, cur:this.expForm.cur, by:this.expForm.by, split:[...this.expForm.split], note:this.expForm.note||'', day:this.expForm.day||'è¡Œå‰æ”¯å‡º'};
                    if (this.editExpIdx!==null && this.exps[this.editExpIdx]) {
                        this.exps[this.editExpIdx] = newExp;
                    } else {
                        this.exps.push(newExp);
                    }
                    this.closeExpAdd();
                    this.saveData();
                },
                delE(i) {
                    if (!this.exps[i]) return;
                    this.exps.splice(i,1);
                    this.saveData();
                },
                openExpenseForm() {
                    // è¨­ç½®ç•¶å‰é¸ä¸­å¤©ä½œç‚ºé è¨­æ—¥æœŸ
                    if (this.days.length > 0 && this.di < this.days.length) {
                        this.expForm.day = 'D' + (this.di + 1);
                    } else {
                        this.expForm.day = 'è¡Œå‰æ”¯å‡º';
                    }
                    this.showExpAdd = true;
                },
                closeExpAdd() {
                    this.showExpAdd=false;
                    this.editExpIdx=null;
                    this.expForm={desc:'',amt:0,cur:'JPY',by:'',split:[],note:'',day:'è¡Œå‰æ”¯å‡º'};
                },
                toggleSelectAll(event) {
                    if (event.target.checked) {
                        // å…¨é¸
                        this.expForm.split = [...this.members];
                    } else {
                        // å–æ¶ˆå…¨é¸
                        this.expForm.split = [];
                    }
                },
                calcSettles(currency) {
                    if (this.members.length===0) return [];
                    var relevantExps = [];
                    for (var i=0; i<this.exps.length; i++) {
                        if (this.exps[i].cur === currency) {
                            relevantExps.push(this.exps[i]);
                        }
                    }
                    if (relevantExps.length===0) return [];

                    var bal = {};
                    for (var i=0; i<this.members.length; i++) {
                        bal[this.members[i]] = 0;
                    }

                    for (var i=0; i<relevantExps.length; i++) {
                        var e = relevantExps[i];
                        if (!e.split || e.split.length===0 || !e.by) continue;
                        // ç¢ºä¿æ”¯ä»˜è€…åœ¨æˆå“¡åˆ—è¡¨ä¸­
                        if (this.members.indexOf(e.by) === -1) continue;

                        var per = e.amt / e.split.length;
                        bal[e.by] = bal[e.by] + e.amt;
                        for (var j=0; j<e.split.length; j++) {
                            // ç¢ºä¿åˆ†æ”¤è€…åœ¨æˆå“¡åˆ—è¡¨ä¸­
                            if (this.members.indexOf(e.split[j]) !== -1) {
                                bal[e.split[j]] = bal[e.split[j]] - per;
                            }
                        }
                    }

                    var debt=[], cred=[];
                    for (var p in bal) {
                        // ä¿ç•™å°æ•¸ï¼Œå››æ¨äº”å…¥åˆ°æ•´æ•¸
                        var b = Math.round(bal[p]);
                        if (b>0) cred.push({name:p,amt:b});
                        else if (b<0) debt.push({name:p,amt:-b});
                    }

                    var res=[], i=0, j=0;
                    while (i<debt.length && j<cred.length) {
                        var d=debt[i].amt, c=cred[j].amt, s=Math.min(d,c);
                        res.push({from:debt[i].name,to:cred[j].name,amt:s});
                        debt[i].amt-=s;
                        cred[j].amt-=s;
                        if (debt[i].amt===0) i++;
                        if (cred[j].amt===0) j++;
                    }
                    return res;
                },
                formatDate(date) {
                    var year = date.getFullYear();
                    var month = date.getMonth() + 1;
                    var day = date.getDate();
                    return year + '/' + month + '/' + day;
                },
                formatShortDate(date) {
                    var month = date.getMonth() + 1;
                    var day = date.getDate();
                    return month + '/' + day;
                },
                parseDateString(dateStr) {
                    // å°‡ "2025/1/6" æ ¼å¼è½‰ç‚ºæ­£ç¢ºçš„Dateç‰©ä»¶
                    var parts = dateStr.split('/');
                    return new Date(parseInt(parts[0]), parseInt(parts[1])-1, parseInt(parts[2]));
                },
                getWeekday(date) {
                    var days = ['SUN','MON','TUE','WED','THU','FRI','SAT'];
                    return days[date.getDay()];
                },
                startEditHeader() {
                    // å‚™ä»½åŸå§‹è³‡æ–™
                    this.backupTitle = this.tripTitle;
                    this.backupDates = this.tripDates;
                    this.backupStartDate = this.startDate;
                    this.backupEndDate = this.endDate;
                    
                    this.editingHeader = true;
                    // åˆå§‹åŒ–æ—¥æœŸé¸æ“‡å™¨
                    if (this.days.length > 0) {
                        var firstDate = this.parseDateString(this.days[0].d);
                        var lastDate = this.parseDateString(this.days[this.days.length-1].d);
                        
                        // è½‰æ›ç‚º YYYY-MM-DD æ ¼å¼
                        this.startDate = this.toISODate(firstDate);
                        this.endDate = this.toISODate(lastDate);
                    }
                },
                toISODate(date) {
                    var year = date.getFullYear();
                    var month = date.getMonth() + 1;
                    var day = date.getDate();
                    var monthStr = month < 10 ? '0' + month : '' + month;
                    var dayStr = day < 10 ? '0' + day : '' + day;
                    return year + '-' + monthStr + '-' + dayStr;
                },
                cancelHeaderEdit() {
                    // é‚„åŸå‚™ä»½
                    this.tripTitle = this.backupTitle;
                    this.tripDates = this.backupDates;
                    this.startDate = this.backupStartDate;
                    this.endDate = this.backupEndDate;
                    this.editingHeader = false;
                },
                saveHeaderEdit() {
                    // æ ¹æ“šåŸå¸‚è‡ªå‹•è¨­å®šå¹£åˆ¥
                    if (this.tripTitle) {
                        var defaultCurrency = this.getCityDefaultCurrency(this.tripTitle);
                        this.targetCurrency = defaultCurrency;
                    }

                    // å¦‚æœæœ‰é¸æ“‡æ—¥æœŸï¼Œé‡æ–°ç”Ÿæˆdays
                    if (this.startDate && this.endDate) {
                        var start = new Date(this.startDate + 'T00:00:00');
                        var end = new Date(this.endDate + 'T00:00:00');
                        var dayDiff = Math.round((end - start) / (1000 * 60 * 60 * 24)) + 1;

                        if (dayDiff > 0 && dayDiff <= 30) {
                            // ä¿ç•™ç¾æœ‰çš„èˆªç­å’Œè¡Œç¨‹è³‡æ–™
                            var oldDays = JSON.parse(JSON.stringify(this.days));

                            this.days = [];
                            for (var i = 0; i < dayDiff; i++) {
                                var currentDate = new Date(start);
                                currentDate.setDate(start.getDate() + i);

                                // æª¢æŸ¥æ˜¯å¦æœ‰å°æ‡‰çš„èˆŠè³‡æ–™
                                var oldDay = i < oldDays.length ? oldDays[i] : null;

                                this.days.push({
                                    d: this.formatDate(currentDate),
                                    s: this.formatShortDate(currentDate),
                                    t: oldDay ? oldDay.t : ('ç¬¬' + (i+1) + 'å¤©'),
                                    items: oldDay ? oldDay.items : [],
                                    weekday: this.getWeekday(currentDate),
                                    flight: oldDay ? oldDay.flight : null
                                });
                            }

                            // ç¢ºä¿diåœ¨æœ‰æ•ˆç¯„åœå…§
                            if (this.di >= this.days.length) {
                                this.di = this.days.length - 1;
                            }

                            // æ›´æ–°tripDatesé¡¯ç¤º
                            var startYear = start.getFullYear();
                            var startMonth = start.getMonth() + 1;
                            var startDay = start.getDate();
                            var endYear = end.getFullYear();
                            var endMonth = end.getMonth() + 1;
                            var endDay = end.getDate();

                            // å¦‚æœèµ·æ­¢æ—¥æœŸåœ¨åŒä¸€å¹´ï¼Œåªåœ¨çµæŸæ—¥æœŸé¡¯ç¤ºå¹´ä»½
                            if (startYear === endYear) {
                                this.tripDates = startMonth + '/' + startDay + ' - ' + endMonth + '/' + endDay + ' ' + endYear;
                            } else {
                                this.tripDates = startYear + '/' + startMonth + '/' + startDay + ' - ' + endYear + '/' + endMonth + '/' + endDay;
                            }
                        } else if (dayDiff > 30) {
                            alert('æœ€å¤šæ”¯æ´30å¤©è¡Œç¨‹');
                            return;
                        } else {
                            alert('çµæŸæ—¥æœŸå¿…é ˆåœ¨é–‹å§‹æ—¥æœŸä¹‹å¾Œ');
                            return;
                        }
                    }

                    this.editingHeader = false;
                    this.saveData();

                    // ç²å–å¤©æ°£è³‡è¨Š
                    this.fetchWeather(this.tripTitle);
                },
                getCurrencyName(currency) {
                    var names = {
                        'JPY': 'æ—¥åœ“ JPY',
                        'USD': 'ç¾å…ƒ USD',
                        'EUR': 'æ­å…ƒ EUR',
                        'KRW': 'éŸ“å…ƒ KRW',
                        'THB': 'æ³°éŠ– THB',
                        'SGD': 'æ–°å¹£ SGD',
                        'CNY': 'äººæ°‘å¹£ CNY',
                        'HKD': 'æ¸¯å¹£ HKD',
                        'AUD': 'æ¾³å¹£ AUD'
                    };
                    return names[currency] || currency;
                },
                getCurrencySymbol(currency) {
                    var symbols = {
                        'JPY': 'Â¥',
                        'USD': '$',
                        'EUR': 'â‚¬',
                        'KRW': 'â‚©',
                        'THB': 'à¸¿',
                        'SGD': 'S$',
                        'CNY': 'Â¥',
                        'HKD': 'HK$',
                        'AUD': 'A$'
                    };
                    return symbols[currency] || '';
                },
                formatExpenseDay(day) {
                    // æ ¼å¼åŒ–æ”¯å‡ºæ—¥æœŸé¡¯ç¤ºç‚º D1ï¼12/21
                    if (!day || day === 'è¡Œå‰æ”¯å‡º') return day;
                    // ç¢ºä¿daysé™£åˆ—å­˜åœ¨
                    if (!this.days || this.days.length === 0) return day;

                    // å…¼å®¹èˆŠæ ¼å¼ "ç¬¬1å¤©" å’Œæ–°æ ¼å¼ "D1"
                    var dayNum;
                    if (day.startsWith('ç¬¬') && day.endsWith('å¤©')) {
                        dayNum = parseInt(day.substring(1, day.length - 1));
                    } else if (day.startsWith('D')) {
                        dayNum = parseInt(day.substring(1));
                    } else {
                        return day;
                    }
                    if (isNaN(dayNum) || dayNum < 1 || dayNum > this.days.length) return day;

                    // ç¢ºä¿è©²å¤©æ•¸æ“šå­˜åœ¨
                    var dayData = this.days[dayNum - 1];
                    if (!dayData || !dayData.date) return day;

                    var dateStr = dayData.date;
                    // å°‡ YYYY/MM/DD æˆ– MM/DD æ ¼å¼è½‰ç‚º MM/DD
                    var parts = dateStr.split('/');
                    var monthDay = parts.length === 3 ? parts[1] + '/' + parts[2] : dateStr;
                    return 'D' + dayNum + 'ï¼' + monthDay;
                },
                getTargetFlag() {
                    var flags = {
                        'JPY': 'ğŸ‡¯ğŸ‡µ',
                        'USD': 'ğŸ‡ºğŸ‡¸',
                        'EUR': 'ğŸ‡ªğŸ‡º',
                        'KRW': 'ğŸ‡°ğŸ‡·',
                        'THB': 'ğŸ‡¹ğŸ‡­',
                        'SGD': 'ğŸ‡¸ğŸ‡¬',
                        'CNY': 'ğŸ‡¨ğŸ‡³',
                        'HKD': 'ğŸ‡­ğŸ‡°',
                        'AUD': 'ğŸ‡¦ğŸ‡º'
                    };
                    return flags[this.targetCurrency] || 'ğŸŒ';
                },
                getTranslateCode() {
                    var codes = {
                        'JPY': 'ja',
                        'USD': 'en',
                        'EUR': 'en',
                        'KRW': 'ko',
                        'THB': 'th',
                        'SGD': 'en',
                        'CNY': 'zh-CN',
                        'HKD': 'zh-HK',
                        'AUD': 'en'
                    };
                    return codes[this.targetCurrency] || 'en';
                },
                getTargetLangName() {
                    var names = {
                        'JPY': 'æ—¥æ–‡',
                        'USD': 'è‹±æ–‡',
                        'EUR': 'è‹±æ–‡',
                        'KRW': 'éŸ“æ–‡',
                        'THB': 'æ³°æ–‡',
                        'SGD': 'è‹±æ–‡',
                        'CNY': 'ç°¡ä¸­',
                        'HKD': 'ç²µèª',
                        'AUD': 'è‹±æ–‡'
                    };
                    return names[this.targetCurrency] || 'å¤–èª';
                },
                getMemberColor(index) {
                    var colors = [
                        '#7a9db8', // è«è˜­è¿ªè—
                        '#8fad8e', // è«è˜­è¿ªç¶ 
                        '#d4a5a5', // è«è˜­è¿ªç²‰
                        '#d4c5a0', // è«è˜­è¿ªé»ƒ
                        '#a9937a'  // è«è˜­è¿ªå’–
                    ];
                    return colors[index % colors.length];
                },
                getCityDefaultCurrency(city) {
                    var cityToCurrency = {
                        'æ±äº¬': 'JPY', 'å¤§é˜ª': 'JPY', 'äº¬éƒ½': 'JPY', 'ç¦å²¡': 'JPY', 'åå¤å±‹': 'JPY', 'åŒ—æµ·é“': 'JPY', 'æ²–ç¹©': 'JPY',
                        'é¦–çˆ¾': 'KRW', 'é‡œå±±': 'KRW', 'æ¿Ÿå·å³¶': 'KRW',
                        'æ›¼è°·': 'THB', 'æ¸…é‚': 'THB', 'æ™®å‰å³¶': 'THB',
                        'æ–°åŠ å¡': 'SGD',
                        'å³‡é‡Œå³¶': 'USD',
                        'é›ªæ¢¨': 'AUD', 'å¢¨çˆ¾æœ¬': 'AUD', 'é»ƒé‡‘æµ·å²¸': 'AUD',
                        'ç´ç´„': 'USD', 'æ´›æ‰ç£¯': 'USD', 'èˆŠé‡‘å±±': 'USD',
                        'å€«æ•¦': 'EUR', 'å·´é»': 'EUR', 'ç¾…é¦¬': 'EUR', 'å·´å¡éš†ç´': 'EUR',
                        'ä¸Šæµ·': 'CNY', 'åŒ—äº¬': 'CNY',
                        'é¦™æ¸¯': 'HKD', 'æ¾³é–€': 'HKD'
                    };
                    return cityToCurrency[city] || 'USD';
                },
                getCityEnglishName(city) {
                    var cityToEnglish = {
                        'æ±äº¬': 'Tokyo', 'å¤§é˜ª': 'Osaka', 'äº¬éƒ½': 'Kyoto', 'ç¦å²¡': 'Fukuoka', 'åå¤å±‹': 'Nagoya', 'åŒ—æµ·é“': 'Sapporo', 'æ²–ç¹©': 'Okinawa',
                        'é¦–çˆ¾': 'Seoul', 'é‡œå±±': 'Busan', 'æ¿Ÿå·å³¶': 'Jeju',
                        'æ›¼è°·': 'Bangkok', 'æ¸…é‚': 'Chiang Mai', 'æ™®å‰å³¶': 'Phuket',
                        'æ–°åŠ å¡': 'Singapore',
                        'å³‡é‡Œå³¶': 'Bali',
                        'é›ªæ¢¨': 'Sydney', 'å¢¨çˆ¾æœ¬': 'Melbourne', 'é»ƒé‡‘æµ·å²¸': 'Gold Coast',
                        'ç´ç´„': 'New York', 'æ´›æ‰ç£¯': 'Los Angeles', 'èˆŠé‡‘å±±': 'San Francisco',
                        'å€«æ•¦': 'London', 'å·´é»': 'Paris', 'ç¾…é¦¬': 'Rome', 'å·´å¡éš†ç´': 'Barcelona',
                        'ä¸Šæµ·': 'Shanghai', 'åŒ—äº¬': 'Beijing',
                        'é¦™æ¸¯': 'Hong Kong', 'æ¾³é–€': 'Macau'
                    };
                    return cityToEnglish[city] || city;
                },
                getWeatherIcon(code, isDay) {
                    // ç·šæ¢é¢¨æ ¼çš„å¤©æ°£åœ–æ¨™ SVG
                    var svgBase = 'width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"';

                    // æ™´å¤© - å¤ªé™½
                    if (code === 113 && isDay) {
                        return '<svg ' + svgBase + '><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>';
                    }
                    // å¤œæ™š - æœˆäº®
                    if (code === 113 && !isDay) {
                        return '<svg ' + svgBase + '><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>';
                    }
                    // å°‘äº‘ - å¤ªé™½+é›²
                    if (code === 116) {
                        return '<svg ' + svgBase + '><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path><circle cx="6" cy="6" r="3"></circle><line x1="6" y1="1" x2="6" y2="2"></line><line x1="2" y1="6" x2="3" y2="6"></line><line x1="10" y1="6" x2="9" y2="6"></line><line x1="3.5" y1="2.5" x2="4.2" y2="3.2"></line><line x1="7.8" y1="2.5" x2="7.1" y2="3.2"></line></svg>';
                    }
                    // å¤šäº‘/é˜´å¤© - é›²
                    if (code === 119 || code === 122) {
                        return '<svg ' + svgBase + '><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path></svg>';
                    }
                    // éœ§ - æ³¢æµªç·š
                    if (code === 143 || code === 248 || code === 260) {
                        return '<svg ' + svgBase + '><path d="M3 15h18M3 9h18M3 21h18"></path></svg>';
                    }
                    // é›·é›¨ - é›²+é–ƒé›»
                    if (code >= 308 && code <= 314 || code === 386 || code === 389 || code === 392) {
                        return '<svg ' + svgBase + '><path d="M19 16.9A5 5 0 0 0 18 7h-1.26a8 8 0 1 0-11.62 9"></path><polyline points="13 11 9 17 15 17 11 23"></polyline></svg>';
                    }
                    // é›ª - é›²+é›ªèŠ±
                    if (code >= 227 && code <= 230 || code >= 317 && code <= 350) {
                        return '<svg ' + svgBase + '><path d="M20 17.58A5 5 0 0 0 18 8h-1.26A8 8 0 1 0 4 16.25"></path><line x1="8" y1="16" x2="8.01" y2="16"></line><line x1="8" y1="20" x2="8.01" y2="20"></line><line x1="12" y1="18" x2="12.01" y2="18"></line><line x1="12" y1="22" x2="12.01" y2="22"></line><line x1="16" y1="16" x2="16.01" y2="16"></line><line x1="16" y1="20" x2="16.01" y2="20"></line></svg>';
                    }
                    // é›¨ - é›²+é›¨æ»´
                    if (code >= 176 && code <= 200 || code >= 263 && code <= 302 || code >= 353 && code <= 392) {
                        return '<svg ' + svgBase + '><line x1="16" y1="13" x2="16" y2="21"></line><line x1="8" y1="13" x2="8" y2="21"></line><line x1="12" y1="15" x2="12" y2="23"></line><path d="M20 16.58A5 5 0 0 0 18 7h-1.26A8 8 0 1 0 4 15.25"></path></svg>';
                    }
                    // é»˜èªæ™´å¤©
                    return '<svg ' + svgBase + '><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>';
                },
                async fetchWeather(city) {
                    if (!city || city === 'æ—…éŠåœ°é»') {
                        this.weather.loaded = false;
                        return;
                    }

                    this.weather.loading = true;
                    this.weather.loaded = false;

                    try {
                        var englishCity = this.getCityEnglishName(city);
                        var url = 'https://wttr.in/' + encodeURIComponent(englishCity) + '?format=j1';

                        console.log('ç²å–å¤©æ°£è³‡è¨Š:', englishCity, url);

                        var response = await fetch(url);
                        if (!response.ok) {
                            console.error('å¤©æ°£ API å›æ‡‰éŒ¯èª¤:', response.status);
                            throw new Error('å¤©æ°£è³‡æ–™ç²å–å¤±æ•—');
                        }

                        var data = await response.json();
                        console.log('å¤©æ°£è³‡æ–™:', data);

                        if (!data.current_condition || !data.current_condition[0]) {
                            console.error('å¤©æ°£è³‡æ–™æ ¼å¼éŒ¯èª¤:', data);
                            throw new Error('å¤©æ°£è³‡æ–™æ ¼å¼éŒ¯èª¤');
                        }

                        var current = data.current_condition[0];

                        this.weather.temp = Math.round(current.temp_C);

                        // å„ªå…ˆä½¿ç”¨ä¸­æ–‡æè¿°ï¼Œå¦‚æœæ²’æœ‰å‰‡ä½¿ç”¨è‹±æ–‡
                        if (current.lang_zh && current.lang_zh[0] && current.lang_zh[0].value) {
                            this.weather.description = this.translateWeatherDesc(current.lang_zh[0].value);
                        } else if (current.weatherDesc && current.weatherDesc[0] && current.weatherDesc[0].value) {
                            this.weather.description = current.weatherDesc[0].value;
                        } else {
                            this.weather.description = 'æœªçŸ¥';
                        }

                        this.weather.humidity = current.humidity;
                        this.weather.windSpeed = Math.round(current.windspeedKmph / 3.6 * 10) / 10;
                        this.weather.icon = this.getWeatherIcon(parseInt(current.weatherCode), current.cloudcover < 50);
                        this.weather.loaded = true;

                        console.log('å¤©æ°£è³‡è¨Šè¼‰å…¥æˆåŠŸ');
                    } catch (error) {
                        console.error('å¤©æ°£ç²å–éŒ¯èª¤:', error);
                        this.weather.loaded = false;
                    } finally {
                        this.weather.loading = false;
                    }
                },
                translateWeatherDesc(desc) {
                    // ç°¡åŒ–å¤©æ°£æè¿°
                    if (!desc) return 'æ™´';
                    if (desc.includes('æ™´')) return 'æ™´å¤©';
                    if (desc.includes('é›²') || desc.includes('å¤šé›²')) return 'å¤šé›²';
                    if (desc.includes('é›¨')) return 'é›¨å¤©';
                    if (desc.includes('é›ª')) return 'é›ªå¤©';
                    if (desc.includes('éœ§')) return 'æœ‰éœ§';
                    if (desc.includes('é›·')) return 'é›·é™£é›¨';
                    return desc.substring(0, 8);
                },
                doExport() {
                    try {
                        var exportObj = {
                            tripTitle: this.tripTitle,
                            tripDates: this.tripDates,
                            targetCurrency: this.targetCurrency,
                            rate: this.rate,
                            days: this.days,
                            members: this.members,
                            exps: this.exps
                        };
                        
                        var dataStr = JSON.stringify(exportObj, null, 2);
                        var blob = new Blob([dataStr], { type: 'application/json' });
                        var url = URL.createObjectURL(blob);
                        var a = document.createElement('a');
                        a.href = url;
                        a.download = (this.tripTitle || 'æ—…éŠè¡Œç¨‹') + '.json';
                        a.style.display = 'none';
                        document.body.appendChild(a);
                        a.click();
                        
                        setTimeout(function() {
                            document.body.removeChild(a);
                            URL.revokeObjectURL(url);
                        }, 100);
                        
                        alert('å·²åŒ¯å‡ºè¡Œç¨‹è³‡æ–™ï¼');
                    } catch (error) {
                        console.error('åŒ¯å‡ºéŒ¯èª¤:', error);
                        alert('åŒ¯å‡ºå¤±æ•—ï¼š' + error.message);
                    }
                },
                triggerImport() {
                    document.getElementById('importFile').click();
                },
                importData(event) {
                    var file = event.target.files[0];
                    if (!file) return;
                    
                    var reader = new FileReader();
                    var self = this;
                    
                    reader.onload = function(e) {
                        try {
                            var importedData = JSON.parse(e.target.result);
                            
                            // ç¢ºèªæ˜¯å¦è¦è¦†è“‹ç¾æœ‰è³‡æ–™
                            if (!confirm('åŒ¯å…¥è³‡æ–™å°‡æœƒè¦†è“‹ç›®å‰çš„è¡Œç¨‹ï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) {
                                event.target.value = '';
                                return;
                            }
                            
                            // åŒ¯å…¥è³‡æ–™
                            if (importedData.tripTitle) self.tripTitle = importedData.tripTitle;
                            if (importedData.tripDates) self.tripDates = importedData.tripDates;
                            if (importedData.targetCurrency) self.targetCurrency = importedData.targetCurrency;
                            if (importedData.rate) self.rate = importedData.rate;
                            if (importedData.days) self.days = importedData.days;
                            if (importedData.members) self.members = importedData.members;
                            if (importedData.exps) self.exps = importedData.exps;
                            
                            // é‡æ–°è¨ˆç®— startDate å’Œ endDate
                            if (self.days.length > 0) {
                                var firstDate = self.parseDateString(self.days[0].d);
                                var lastDate = self.parseDateString(self.days[self.days.length-1].d);
                                self.startDate = self.toISODate(firstDate);
                                self.endDate = self.toISODate(lastDate);
                            }
                            
                            // å„²å­˜
                            self.saveData();
                            
                            alert('åŒ¯å…¥æˆåŠŸï¼');
                            
                            // æ¸…é™¤æª”æ¡ˆè¼¸å…¥
                            event.target.value = '';
                        } catch (error) {
                            alert('åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼éŒ¯èª¤');
                            event.target.value = '';
                        }
                    };
                    
                    reader.readAsText(file);
                },
                doImport(event) {
                    // åˆ¥åå‡½æ•¸ï¼ŒæŒ‡å‘ importData
                    this.importData(event);
                },
                clearAllData() {
                    // ç¬¬ä¸€æ¬¡ç¢ºèª
                    if (!confirm('âš ï¸ è­¦å‘Šï¼šæ¸…é™¤æ‰€æœ‰è³‡æ–™å°‡æœƒåˆªé™¤ç›®å‰çš„è¡Œç¨‹ã€æˆå“¡å’Œæ”¯å‡ºè¨˜éŒ„ã€‚\n\nå»ºè­°å…ˆä½¿ç”¨ã€ŒåŒ¯å‡ºè¡Œç¨‹è³‡æ–™ã€å‚™ä»½ã€‚\n\nç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) {
                        return;
                    }

                    // ç¬¬äºŒæ¬¡ç¢ºèª
                    if (!confirm('âš ï¸ æœ€å¾Œç¢ºèªï¼šæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼\n\nç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿ')) {
                        return;
                    }

                    // æ¸…é™¤æ‰€æœ‰æ•¸æ“š
                    this.tripTitle = 'æ—…éŠåœ°é»';
                    this.tripDates = '';
                    this.startDate = '';
                    this.endDate = '';
                    this.targetCurrency = 'JPY';
                    this.rate = 0.21;
                    this.days = [];
                    this.members = [];
                    this.exps = [];
                    this.di = 0;
                    this.cvAmt = 0;
                    this.cvFrom = 'JPY';

                    // æ¸…é™¤ localStorage
                    localStorage.removeItem('tripData');

                    // é‡æ–°è¼‰å…¥é è¨­æ•¸æ“š
                    this.saveData();

                    alert('âœ“ å·²æ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼Œå›å¾©åˆ°åˆå§‹ç‹€æ…‹ã€‚');

                    // åˆ‡æ›åˆ°è¡Œç¨‹é é¢
                    this.tab = 'plan';
                }
            },
            mounted() {
                var self = this;
                setTimeout(function() {
                    self.loadData();
                    // è¼‰å…¥å®Œæˆå¾Œç²å–å¤©æ°£
                    if (self.tripTitle && self.tripTitle !== 'æ—…éŠåœ°é»') {
                        self.fetchWeather(self.tripTitle);
                    }
                }, 100);
            },
            watch: {
                tab: function() { this.saveData(); },
                di: function() { 
                    if (this.di >= this.days.length) {
                        this.di = 0;
                    }
                    this.saveData(); 
                }
            }
        });
        
        // å®‰å…¨åœ° mount Vue app
        try {
            app.mount('#app');
            console.log('æ—…éŠå°å¹«æ‰‹å·²æˆåŠŸè¼‰å…¥');
        } catch (error) {
            console.error('Vue mount å¤±æ•—:', error);
            document.getElementById('app').innerHTML = '<div style="padding: 20px; text-align: center;"><h1>åˆå§‹åŒ–å¤±æ•—</h1><p>è«‹é‡æ–°æ•´ç†é é¢æˆ–æ¸…é™¤ç€è¦½å™¨å¿«å–ã€‚</p><p style="color: red; font-size: 12px;">éŒ¯èª¤: ' + error.message + '</p></div>';
        }
    </script>
</body>
</html>
